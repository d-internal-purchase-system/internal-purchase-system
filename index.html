<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>사내 구매 주문 요청</title>

  <!-- 주소검색(다음/카카오). 사내망에서 차단되면 주소검색이 안 뜰 수 있음 -->
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#111827; --danger:#b91c1c; --ok:#065f46; --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","맑은 고딕",Arial,sans-serif;background:var(--bg);color:var(--text);}
    .container{max-width:1080px;margin:0 auto;padding:22px 14px 48px;}
    header{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;margin-bottom:14px;}
    h1{margin:0;font-size:20px;letter-spacing:-.2px;}
    .subtitle{margin:6px 0 0;font-size:12.5px;line-height:1.45;color:var(--muted);}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--line);background:#fff;border-radius:999px;font-size:12px;color:var(--muted);box-shadow:0 2px 10px rgba(17,24,39,.04);white-space:nowrap;}
    .pill b{color:var(--text)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .cardBody{padding:14px 16px;}
    .muted{color:var(--muted)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:13px;}
    .btn.primary{background:#111827;border-color:#111827;color:#fff;}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fff;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .divider{border:none;border-top:1px solid var(--line);margin:14px 0;}
    .stepper{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 14px;}
    .step{flex:1;min-width:140px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:flex-start;}
    .stepNum{width:28px;height:28px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;font-weight:900;font-size:12px;color:var(--muted);}
    .step.active{border-color:#111827}
    .step.active .stepNum{border-color:#111827;color:#111827}
    .stepTitle{font-weight:900;font-size:13px;letter-spacing:-.1px;margin:0}
    .stepDesc{margin:4px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .section{display:none}
    .section.active{display:block}

    /* grid layout for step1 */
    .step1Grid{display:grid;grid-template-columns: 1.55fr .95fr; gap:12px; align-items:start;}
    @media (max-width:960px){.step1Grid{grid-template-columns:1fr}}
    .panel{border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden;}
    .panelHeader{padding:12px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .panelHeader h3{margin:0;font-size:13px;letter-spacing:-.1px;}
    .panelBody{padding:12px 12px;}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);white-space:nowrap;}
    .badge strong{color:var(--text)}

    /* products */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;cursor:pointer;}
    .tab.active{background:#111827;border-color:#111827;color:#fff;}

    /* products */
.products{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:10px;
}
@media (max-width:520px){
  .products{ grid-template-columns: 1fr; }
}


    .product{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px;min-width:0;}
.productTop{
  display:flex;
  gap:12px;
  align-items:flex-start;
  min-width:0;
  flex-wrap:wrap; /* 좁아지면 줄바꿈 */
}
    .thumb{
      width:64px;height:64px;border-radius:14px;border:1px solid var(--line);
      background:#f9fafb;display:grid;place-items:center;overflow:hidden;flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .thumb .ph{font-size:12px;color:var(--muted);font-weight:900}

    /* ✅ 세로로 깨지는 문제 방지: 최소 폭 확보 + 줄바꿈 정책 + 라인클램프 */
    .productInfo{flex:1 1 auto;min-width:0;}
    .productName{
      margin:0;font-weight:900;font-size:13.5px;letter-spacing:-.1px;
      word-break:keep-all; overflow-wrap:break-word;
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2;
      overflow:hidden;
    }
    .productMeta{
      margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.45;
      word-break:keep-all; overflow-wrap:break-word;
      display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3;
      overflow:hidden;
    }
.price{
  margin-left:auto;
  font-weight:900;
  white-space:nowrap;
  flex:0 0 auto;
}

/* 카드가 좁아질 때 가격을 아래줄로 내려 공간 확보 */
@media (max-width:860px){
  .price{
    width:100%;
    text-align:right;
    margin-left:0;
  }
}
    .qty{width:86px;padding:8px 10px;border:1px solid var(--line);border-radius:12px;font-size:14px;outline:none;}
    .miniHint{font-size:12px;color:var(--muted);line-height:1.4;margin-top:4px;}

    /* cart */
    .cartList{display:flex;flex-direction:column;gap:10px;}
    .cartItem{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff;display:flex;justify-content:space-between;gap:10px;min-width:0;}
    .cartItem .name{
      margin:0;font-weight:900;font-size:13px;max-width:360px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;
    }
    .cartItem .meta{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35;}
    .mini{display:flex;gap:6px;align-items:center;justify-content:flex-end;}
    .miniBtn{width:30px;height:30px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900;display:grid;place-items:center;}
    .miniQty{min-width:26px;text-align:center;font-weight:900;font-size:13px;}
    .sumBox{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff;}
    .sumRow{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin:6px 0;}
    .sumRow strong{font-weight:900}

    /* forms */
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
    input[type="text"], input[type="tel"], textarea{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;outline:none;background:#fff;
    }
    textarea{min-height:90px;resize:vertical;}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:520px){.form{grid-template-columns:1fr}}
    .help{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}

    /* modal */
    .backdrop{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .backdrop.open{display:flex;}
    .modal{width:min(920px,100%);background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 18px 60px rgba(17,24,39,.22);overflow:hidden;display:flex;flex-direction:column;max-height:86vh;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex:0 0 auto;}
    .modalHeader h3{margin:0;font-size:15px;letter-spacing:-.1px;}
    .modalBody{padding:14px 16px;overflow:auto;flex:1 1 auto;}
    .modalFooter{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;align-items:center;gap:10px;background:#fff;flex:0 0 auto;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;word-break:keep-all;overflow-wrap:break-word;}
    th{font-size:12px;color:var(--muted);font-weight:900;}
    .tfoot td{font-weight:900;border-bottom:none;padding-top:12px;}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);white-space:nowrap;}
    .status.ok{border-color:#bbf7d0;color:var(--ok);background:#f0fdf4;}
    .status.err{border-color:#fecaca;color:var(--danger);background:#fff1f2;}

    /* gate */
    .policy{font-size:12px;line-height:1.6;background:#f9fafb;border:1px solid var(--line);border-radius:14px;padding:12px;max-height:260px;overflow:auto;}
    .checkRow{display:flex;gap:10px;align-items:flex-start;margin-top:12px;}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-size:13px;box-shadow:0 12px 30px rgba(17,24,39,.22);opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:60;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px);}

    /* address search layer (embed) */
    .addrLayer{
      display:none;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      height:420px;
      background:#fff;
      margin-top:10px;
    }
    .addrLayer.open{display:block;}

    /* account info */
    .accountBox{
      border:1px solid var(--line);
      border-radius:14px;
      background:#f9fafb;
      padding:12px;
    }
    .accountBox .title{font-weight:900;margin:0 0 6px;}
    .accountBox .text{margin:0;color:var(--muted);font-size:12.5px;line-height:1.55;}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;font-size:13px;line-height:1.35;}
    @media (max-width:520px){.kvs{grid-template-columns:1fr}}

    /* step1 cart preview */
    .cartPreviewEmpty{font-size:12px;color:var(--muted);line-height:1.5;}
  </style>
</head>

<body>
  <div class="container" id="app" style="display:none;">
    <header>
      <div>
        <h1>사내 구매 주문 요청</h1>
        <p class="subtitle">관리자 승인 후 <b>택배로만</b> 발송됩니다. 기본 배송비는 <b>무료</b>이며, <b>제주/도서산간</b>은 우편번호 기준으로 추가배송비가 적용될 수 있습니다.</p>
      </div>
      <div class="pill" id="topPill">출고: <b>택배발송</b> · 배송비: <b id="topShipFee">0원</b></div>
    </header>

    <div class="stepper">
      <div class="step active" id="step1"><div class="stepNum">1</div><div><p class="stepTitle">상품 선택</p><p class="stepDesc">카테고리에서 담기</p></div></div>
      <div class="step" id="step2"><div class="stepNum">2</div><div><p class="stepTitle">주문자 정보</p><p class="stepDesc">요청자 입력</p></div></div>
      <div class="step" id="step3"><div class="stepNum">3</div><div><p class="stepTitle">수령자/주소</p><p class="stepDesc">배송 정보 입력</p></div></div>
      <div class="step" id="step4"><div class="stepNum">4</div><div><p class="stepTitle">최종 확인</p><p class="stepDesc">요약 후 제출</p></div></div>
    </div>

    <div class="card">
      <div class="cardBody">

        <!-- SECTION 1 -->
        <div class="section active" id="section1">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">상품 선택</h2>
              <div class="muted" style="font-size:12px;margin-top:6px;">카테고리에서 담고, 오른쪽 장바구니에서 수량을 조절하세요.</div>
            </div>
            <button class="btn danger" id="clearCartBtn" disabled>장바구니 비우기</button>
          </div>

          <div class="divider"></div>

          <div class="step1Grid">
            <!-- left: products -->
            <div class="panel">
              <div class="panelHeader">
                <h3>상품 목록</h3>
                <span class="badge">배송비 <strong id="badgeShipFee">0원</strong></span>
              </div>
              <div class="panelBody">
                <div class="tabs" id="tabs"></div>
                <div class="products" id="products"></div>
              </div>
            </div>

            <!-- right: cart preview -->
            <div class="panel">
              <div class="panelHeader">
                <h3>장바구니</h3>
                <span class="badge">담긴 상품 <strong id="cartCount">0</strong></span>
              </div>
              <div class="panelBody">
                <div id="cartPreview"></div>

                <div class="divider"></div>

                <div class="sumBox">
                  <div class="sumRow"><span class="muted">상품 합계</span><strong id="itemsTotal">0원</strong></div>
                  <div class="sumRow"><span class="muted">배송비</span><strong id="shipFeeLine">0원</strong></div>
                  <div class="sumRow"><span>총 결제금액(실결제 없음)</span><strong id="grandTotal">0원</strong></div>
                  <div class="miniHint" id="shipReason" style="margin-top:8px;"></div>
                </div>

                <div class="divider"></div>

                <div class="row" style="justify-content:flex-end;">
                  <button class="btn primary" id="toStep2" disabled>다음</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECTION 2 -->
        <div class="section" id="section2">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">주문자(요청자) 정보</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">주문은 회사 사람이 해도, 수령자는 가족/지인으로 설정 가능합니다.</div>

          <div class="divider"></div>

          <div class="form">
            <div>
              <label>주문자 이름 *</label>
              <input type="text" id="ordererName" placeholder="예) 홍길동">
            </div>
            <div>
              <label>사번(직원번호) *</label>
              <input type="text" id="ordererEmpId" placeholder="예) 123456">
            </div>
            <div>
              <label>주문자 연락처 *</label>
              <input type="tel" id="ordererPhone" placeholder="예) 010-1234-5678">
            </div>
            <div>
              <label>부서 *</label>
              <input type="text" id="ordererDept" placeholder="예) 영업지원팀">
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo1">이전</button>
            <button class="btn primary" id="toStep3" disabled>다음</button>
          </div>
        </div>

        <!-- SECTION 3 -->
        <div class="section" id="section3">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">수령자(배송 정보)</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">우편번호 기준으로 제주/도서산간 추가배송비가 자동 적용될 수 있습니다.</div>

          <div class="divider"></div>

          <div class="form">
            <div>
              <label>수령인 이름 *</label>
              <input type="text" id="recvName" placeholder="예) 김철수">
            </div>
            <div>
              <label>수령인 연락처 *</label>
              <input type="tel" id="recvPhone" placeholder="예) 010-0000-0000">
            </div>

            <div>
              <label>우편번호 *</label>
              <input type="text" id="zip" readonly placeholder="주소 검색으로 자동입력">
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="addrSearchBtn" type="button" style="width:100%;">주소 검색</button>
            </div>

            <div style="grid-column:1 / -1;">
              <label>기본주소(도로명/지번) *</label>
              <input type="text" id="addr1" readonly placeholder="주소 검색으로 자동입력">
            </div>
            <div style="grid-column:1 / -1;">
              <label>상세주소 *</label>
              <input type="text" id="addr2" placeholder="예) 101동 1203호">
            </div>
          </div>

          <!-- 주소검색 embed 영역 -->
          <div class="addrLayer" id="addrLayer"></div>

          <div class="help" id="addrHelp"></div>

          <div class="divider"></div>

          <div class="sumBox">
            <div class="sumRow"><span class="muted">현재 배송비</span><strong id="shipFeeNow">0원</strong></div>
            <div class="miniHint" id="shipReasonNow"></div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo2">이전</button>
            <button class="btn primary" id="toStep4" disabled>다음</button>
          </div>
        </div>

        <!-- SECTION 4 -->
        <div class="section" id="section4">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">최종 확인</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">요약을 확인하고 제출하세요.</div>

          <div class="divider"></div>

          <div class="cartList" id="cartList"></div>

          <div class="divider"></div>

          <div class="sumBox">
            <div class="sumRow"><span class="muted">상품 합계</span><strong id="itemsTotal2">0원</strong></div>
            <div class="sumRow"><span class="muted">배송비</span><strong id="shipFeeLine2">0원</strong></div>
            <div class="sumRow"><span>총 결제금액(실결제 없음)</span><strong id="grandTotal2">0원</strong></div>
            <div class="miniHint" id="shipReason2" style="margin-top:8px;"></div>
          </div>

          <div class="divider"></div>

          <div class="accountBox">
            <p class="title">입금 안내</p>
            <p class="text">
              승인 후 안내에 따라 입금이 필요할 수 있습니다.<br>
              <b>입금계좌:</b> (여기에 계좌정보를 입력하세요)<br>
              <span class="muted">예) 은행명 / 예금주 / 계좌번호</span>
            </p>
          </div>

          <div class="divider"></div>

          <label>비고</label>
          <textarea id="note" placeholder="예) 문 앞에 놓아주세요 / 부재 시 연락 부탁드립니다."></textarea>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo3">이전</button>
            <button class="btn primary" id="submitBtn">제출 전 요약 보기</button>
          </div>

          <div class="help">제출 후에는 관리자가 승인 절차를 진행합니다.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Gate (동의) -->
  <div class="backdrop open" id="gateBackdrop" aria-hidden="false">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
      <div class="modalHeader">
        <h3 id="gateTitle">주문 전 필수 안내</h3>
        <span class="status err">동의 필요</span>
      </div>
      <div class="modalBody">
        <div class="policy">
          <b>[필수 확인 사항]</b><br><br>
          1) 본 페이지는 <b>사내 승인용 주문 요청</b>이며, 결제는 발생하지 않습니다.<br>
          2) 신청한 물품은 내부 기준에 따라 <b>승인/반려</b>될 수 있습니다.<br>
          3) 출고는 <b>택배발송</b>이며, <b>기본 무료</b>이나 우편번호 기준으로 <b>제주/도서산간</b> 추가배송비가 적용될 수 있습니다.<br>
          4) 수령자/주소/연락처 오류로 인한 배송 문제는 재발송이 제한될 수 있습니다.<br>
          5) 입력 정보는 주문 처리 목적에 한해 사용됩니다.<br><br>
          위 내용을 확인했으며, 정확한 정보를 입력하겠습니다.
        </div>
        <div class="checkRow">
          <input type="checkbox" id="agreeChk">
          <div>
            <b>위 안내사항을 모두 읽었고 동의합니다.</b><br>
            <span class="muted" style="font-size:12px;">체크 후 “시작하기”를 눌러주세요.</span>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn primary" id="startBtn" disabled>시작하기</button>
      </div>
    </div>
  </div>

  <!-- Summary Modal -->
  <div class="backdrop" id="summaryBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
      <div class="modalHeader">
        <h3 id="summaryTitle">제출 요약</h3>
        <button class="btn" id="closeSummaryBtn">닫기</button>
      </div>

      <div class="modalBody">
        <div class="card" style="box-shadow:none;">
          <div class="cardBody" style="padding:12px;">
            <div class="kvs" id="summaryKV"></div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;margin-top:10px;">
          <div class="cardBody" style="padding:12px;">
            <table>
              <thead>
                <tr>
                  <th>카테고리</th>
                  <th>상품</th>
                  <th style="text-align:right;">단가</th>
                  <th style="text-align:right;">수량</th>
                  <th style="text-align:right;">합계</th>
                </tr>
              </thead>
              <tbody id="summaryItems"></tbody>
              <tfoot>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">상품 합계</td>
                  <td id="summaryItemsTotal" style="text-align:right;"></td>
                </tr>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">배송비</td>
                  <td id="summaryShipFee" style="text-align:right;"></td>
                </tr>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">총 결제금액(실결제 없음)</td>
                  <td id="summaryGrandTotal" style="text-align:right;"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="help">주문금액 확인 후 입금 부탁 드립니다.</div>
      </div>

      <!-- 버튼이 항상 보이도록 footer 고정 -->
      <div class="modalFooter">
        <span class="status" id="sendStatus">전송 대기</span>
        <button class="btn" id="copyJsonBtn" style="display:none;">JSON 복사</button>
        <button class="btn primary" id="confirmSendBtn">최종 제출</button>
      </div>
    </div>
  </div>

  <script>
    /**********************************************************
     * (숨김) 제출 엔드포인트: 사이트에는 언급/표시 없음
     **********************************************************/
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzm2Yjy6K5hj8o79IL-_YTgMyD7VTi9VO0JJEfhOzo42rHOhOhTAMpeOPO5chpggPLW/exec";

    /**********************************************************
     * 배송비 정책 (우편번호 기준)
     **********************************************************/
    const SHIPPING_BASE_FEE = 0;
    const SHIPPING_JEJU_FEE = 3000;     // 제주 3천원
    const SHIPPING_ISLAND_FEE = 5000;   // 도서산간 5천원

    const ZIP_RULES = [
      { type: "jeju", ranges: [[63000, 63644]] },
      { type: "island", ranges: [
        [22386, 22388],
        [23004, 23010],
        [23100, 23116],
        [23124, 23136],
        [31708, 31708],
        [32133, 32133],
        [33411, 33411],
        [40200, 40240],
        [46768, 46771],
        [52570, 52571],
        [53031, 53033],
        [53089, 53104],
        [54000, 54000],
        [56347, 56349],
        [57068, 57069],
        [58760, 58762],
        [58800, 58810],
        [58816, 58818],
        [28826, 28826],
        [58828, 58866],
        [58953, 58958],
        [59102, 59103],
        [59106, 59106],
        [59127, 59127],
        [59129, 59129],
        [59137, 59166],
        [59650, 59650],
        [59766, 59766],
        [59781, 59790],
      ]},
    ];

    function zipToInt(zip){
      const n = parseInt(String(zip || "").replace(/\D/g, ""), 10);
      return Number.isFinite(n) ? n : null;
    }
    function matchZip(zipInt, ranges){
      for (const [s,e] of ranges){
        if (zipInt >= s && zipInt <= e) return true;
      }
      return false;
    }
    function shippingByZip(zip){
      const z = zipToInt(zip);
      if (z === null) return { fee: SHIPPING_BASE_FEE, reason: "기본 무료배송" };

      const jejuRule = ZIP_RULES.find(r => r.type === "jeju");
      if (jejuRule && matchZip(z, jejuRule.ranges)) {
        return { fee: SHIPPING_JEJU_FEE, reason: "제주 추가배송비" };
      }

      const islandRule = ZIP_RULES.find(r => r.type === "island");
      if (islandRule && matchZip(z, islandRule.ranges)) {
        return { fee: SHIPPING_ISLAND_FEE, reason: "도서산간 추가배송비" };
      }

      return { fee: SHIPPING_BASE_FEE, reason: "기본 무료배송" };
    }

    /**********************************************************
     * 데이터 (✅ 카테고리 4개 / 각 6개 샘플)
     **********************************************************/
    const CATEGORIES = [
      { key: "면도(휴대용)", label: "면도(휴대용)" },
      { key: "면도(시스템)", label: "면도(시스템)" },
      { key: "주방용품", label: "주방용품" },
      { key: "쿡웨어", label: "쿡웨어" },
    ];

    // image: "https://..." 넣으면 이미지 표시됨. (로컬이면 같은 repo에 두고 경로 지정)
    const PRODUCTS = [
      // 면도(휴대용) 6
      { id:"PR-01", category:"면도(휴대용)", name:"휴대용 면도기 세트(파우치)", price:6900, desc:"휴대용 구성", detail:"파우치 포함 / 출장용", image:"" },
      { id:"PR-02", category:"면도(휴대용)", name:"미니 쉐이빙 젤", price:3200, desc:"50ml", detail:"간편 세정", image:"" },
      { id:"PR-03", category:"면도(휴대용)", name:"면도날 트래블 2입", price:2800, desc:"리필 2EA", detail:"휴대형", image:"" },
      { id:"PR-04", category:"면도(휴대용)", name:"휴대용 애프터샤워 로션", price:4100, desc:"60ml", detail:"사용감 산뜻", image:"" },
      { id:"PR-05", category:"면도(휴대용)", name:"트래블 면도기 캡", price:1200, desc:"보관용 캡", detail:"위생 보관", image:"" },
      { id:"PR-06", category:"면도(휴대용)", name:"휴대용 일회용 면도기 5입", price:3500, desc:"5EA", detail:"비상용", image:"" },

      // 면도(시스템) 6
      { id:"SR-01", category:"면도(시스템)", name:"시스템 면도기 핸들", price:3500, desc:"핸들 1EA", detail:"정품 리필 호환", image:"" },
      { id:"SR-02", category:"면도(시스템)", name:"시스템 면도날 4입", price:4200, desc:"리필 4EA", detail:"정품 리필", image:"" },
      { id:"SR-03", category:"면도(시스템)", name:"프리미엄 면도날 6입", price:7800, desc:"리필 6EA", detail:"부드러운 절삭", image:"" },
      { id:"SR-04", category:"면도(시스템)", name:"쉐이빙 폼", price:5800, desc:"폼 1EA", detail:"풍성 거품", image:"" },
      { id:"SR-05", category:"면도(시스템)", name:"애프터쉐이브 로션", price:8900, desc:"로션 1EA", detail:"면도 후 진정", image:"" },
      { id:"SR-06", category:"면도(시스템)", name:"면도날 보관 스탠드", price:2600, desc:"스탠드 1EA", detail:"건조/보관", image:"" },

      // 주방용품 6
      { id:"KT-01", category:"주방용품", name:"주방세제", price:4200, desc:"세제 1EA", detail:"기름때 제거", image:"" },
      { id:"KT-02", category:"주방용품", name:"수세미 3입", price:3000, desc:"수세미 3EA", detail:"교체용", image:"" },
      { id:"KT-03", category:"주방용품", name:"키친타월 2롤", price:4500, desc:"2ROLL", detail:"흡수력 우수", image:"" },
      { id:"KT-04", category:"주방용품", name:"고무장갑", price:2900, desc:"1SET", detail:"사이즈 옵션 가능", image:"" },
      { id:"KT-05", category:"주방용품", name:"지퍼백(중) 20매", price:2400, desc:"20EA", detail:"보관/소분", image:"" },
      { id:"KT-06", category:"주방용품", name:"랩(소) 30m", price:3600, desc:"30m", detail:"데일리 사용", image:"" },

      // 쿡웨어 6
      { id:"CW-01", category:"쿡웨어", name:"프라이팬 24cm", price:17900, desc:"1EA", detail:"논스틱 코팅", image:"" },
      { id:"CW-02", category:"쿡웨어", name:"프라이팬 28cm", price:21900, desc:"1EA", detail:"대용량", image:"" },
      { id:"CW-03", category:"쿡웨어", name:"양수냄비 20cm", price:23900, desc:"1EA", detail:"국/찌개용", image:"" },
      { id:"CW-04", category:"쿡웨어", name:"궁중팬 28cm", price:25900, desc:"1EA", detail:"볶음/튀김용", image:"" },
      { id:"CW-05", category:"쿡웨어", name:"실리콘 조리도구 3종", price:9900, desc:"3EA", detail:"스크래치 방지", image:"" },
      { id:"CW-06", category:"쿡웨어", name:"유리뚜껑 24cm", price:6900, desc:"1EA", detail:"호환 뚜껑", image:"" },
    ];

    const state = {
      activeCategory: CATEGORIES[0].key,
      cart: new Map(),
      shipFee: SHIPPING_BASE_FEE,
      shipFeeReason: "기본 무료배송"
    };

    const el = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("ko-KR").format(n);

    function toast(msg){
      const t = el("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1600);
    }

    function calcItemsTotal(){
      let total = 0;
      for (const {product, qty} of state.cart.values()) total += product.price * qty;
      return total;
    }
    function calcGrandTotal(){ return calcItemsTotal() + state.shipFee; }

    function setStep(active){
      ["1","2","3","4"].forEach(n=>{
        el("step"+n).classList.toggle("active", n===String(active));
        el("section"+n).classList.toggle("active", n===String(active));
      });
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function validateStepButtons(){
      // step1: cart required
      el("toStep2").disabled = !(state.cart.size > 0);

      // step2: orderer required (✅ 전화번호 필수 + 사번 필수)
      const ordererOk =
        el("ordererName").value.trim() &&
        el("ordererEmpId").value.trim() &&
        el("ordererPhone").value.trim() &&
        el("ordererDept").value.trim();

      el("toStep3").disabled = !(state.cart.size > 0 && ordererOk);

      // step3: recipient/address required
      const recvOk = el("recvName").value.trim() && el("recvPhone").value.trim();
      const addrOk = el("zip").value.trim() && el("addr1").value.trim() && el("addr2").value.trim();
      el("toStep4").disabled = !(state.cart.size > 0 && ordererOk && recvOk && addrOk);

      el("clearCartBtn").disabled = !(state.cart.size > 0);
    }

    function recalcShipping(){
      const ship = shippingByZip(el("zip").value);
      state.shipFee = ship.fee;
      state.shipFeeReason = ship.reason;
      renderTotals();
    }

    function renderTabs(){
      const wrap = el("tabs");
      wrap.innerHTML = "";
      for (const c of CATEGORIES){
        const b = document.createElement("button");
        b.className = "tab" + (c.key === state.activeCategory ? " active" : "");
        b.textContent = c.label;
        b.onclick = ()=>{ state.activeCategory = c.key; renderTabs(); renderProducts(); };
        wrap.appendChild(b);
      }
    }

    function renderProducts(){
      const wrap = el("products");
      wrap.innerHTML = "";
      const list = PRODUCTS.filter(p=>p.category===state.activeCategory);

      for (const p of list){
        const card = document.createElement("div");
        card.className = "product";

        const top = document.createElement("div");
        top.className = "productTop";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        if (p.image){
          const img = document.createElement("img");
          img.src = p.image;
          img.alt = p.name;
          img.loading = "lazy";
          thumb.appendChild(img);
        } else {
          const ph = document.createElement("div");
          ph.className = "ph";
          ph.textContent = "IMG";
          thumb.appendChild(ph);
        }

        const info = document.createElement("div");
        info.className = "productInfo";

        const name = document.createElement("p");
        name.className = "productName";
        name.textContent = p.name;

        const meta = document.createElement("p");
        meta.className = "productMeta";
        const detail = p.detail ? ` · ${p.detail}` : "";
        meta.textContent = `${p.id} · ${p.desc}${detail}`;

        info.appendChild(name);
        info.appendChild(meta);

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = `${fmt(p.price)}원`;

        top.appendChild(thumb);
        top.appendChild(info);
        top.appendChild(price);

        const row = document.createElement("div");
        row.className = "row";
        row.style.justifyContent = "space-between";

        const qtyWrap = document.createElement("div");
        qtyWrap.className = "row";

        const qty = document.createElement("input");
        qty.type="number"; qty.min="1"; qty.step="1"; qty.value="1"; qty.className="qty";

        const btn = document.createElement("button");
        btn.className="btn primary"; btn.textContent="담기";
        btn.onclick = ()=>{
          const q = Math.max(1, parseInt(qty.value||"1",10));
          addToCart(p.id, q);
        };

        qtyWrap.appendChild(qty);
        qtyWrap.appendChild(btn);

        const hint = document.createElement("div");
        hint.className = "miniHint";
        hint.textContent = "담기 후 장바구니에서 수량 조절 가능";

        row.appendChild(qtyWrap);
        card.appendChild(top);
        card.appendChild(row);
        card.appendChild(hint);
        wrap.appendChild(card);
      }
    }

    function addToCart(productId, qty){
      const product = PRODUCTS.find(x=>x.id===productId);
      if(!product) return;
      if(state.cart.has(productId)){
        const cur = state.cart.get(productId);
        cur.qty += qty;
        state.cart.set(productId, cur);
      }else{
        state.cart.set(productId, {product, qty});
      }
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
      toast("장바구니에 담았습니다");
    }

    function changeQty(productId, delta){
      if(!state.cart.has(productId)) return;
      const cur = state.cart.get(productId);
      cur.qty += delta;
      if(cur.qty<=0) state.cart.delete(productId);
      else state.cart.set(productId, cur);
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
    }

    function clearCart(){
      state.cart.clear();
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
      toast("장바구니를 비웠습니다");
      setStep(1);
    }

    function renderTotals(){
      const itemsTotal = calcItemsTotal();
      const grandTotal = calcGrandTotal();

      el("itemsTotal").textContent = `${fmt(itemsTotal)}원`;
      el("grandTotal").textContent = `${fmt(grandTotal)}원`;
      el("itemsTotal2").textContent = `${fmt(itemsTotal)}원`;
      el("grandTotal2").textContent = `${fmt(grandTotal)}원`;

      // shipping lines
      el("shipFeeLine").textContent = `${fmt(state.shipFee)}원`;
      el("shipFeeLine2").textContent = `${fmt(state.shipFee)}원`;
      el("shipFeeNow").textContent = `${fmt(state.shipFee)}원`;
      el("topShipFee").textContent = `${fmt(state.shipFee)}원`;
      el("badgeShipFee").textContent = `${fmt(state.shipFee)}원`;

      // reasons
      const r = state.shipFeeReason ? `(${state.shipFeeReason})` : "";
      el("shipReason").textContent = r ? `※ ${r}` : "";
      el("shipReason2").textContent = r ? `※ ${r}` : "";
      el("shipReasonNow").textContent = r ? `※ ${r}` : "";
    }

    function renderCartPreview(){
      el("cartCount").textContent = String(state.cart.size);
      const wrap = el("cartPreview");
      wrap.innerHTML = "";

      if(state.cart.size===0){
        const d = document.createElement("div");
        d.className = "cartPreviewEmpty";
        d.textContent = "장바구니가 비어있습니다. 상품을 담아주세요.";
        wrap.appendChild(d);
        return;
      }

      for(const [id,{product,qty}] of state.cart.entries()){
        const item = document.createElement("div");
        item.className="cartItem";
        item.innerHTML = `
          <div style="min-width:0;">
            <p class="name">${product.name}</p>
            <p class="meta">${product.category} · ${product.id} · 단가 ${fmt(product.price)}원</p>
          </div>
          <div style="text-align:right;">
            <div class="mini">
              <button class="miniBtn" type="button" data-minus="${id}">−</button>
              <div class="miniQty">${qty}</div>
              <button class="miniBtn" type="button" data-plus="${id}">+</button>
            </div>
            <div style="margin-top:6px;font-weight:900;">${fmt(product.price*qty)}원</div>
          </div>
        `;
        wrap.appendChild(item);
      }

      wrap.querySelectorAll("[data-minus]").forEach(b=>{
        b.onclick = ()=>changeQty(b.dataset.minus, -1);
      });
      wrap.querySelectorAll("[data-plus]").forEach(b=>{
        b.onclick = ()=>changeQty(b.dataset.plus, +1);
      });
    }

    function renderCartForStep4(){
      const wrap = el("cartList");
      wrap.innerHTML = "";
      if(state.cart.size===0){
        const d = document.createElement("div");
        d.className="sumBox";
        d.innerHTML = `<div class="muted" style="font-size:12px;">장바구니가 비어있습니다. 1단계에서 상품을 담아주세요.</div>`;
        wrap.appendChild(d);
        return;
      }
      for(const [id,{product,qty}] of state.cart.entries()){
        const item = document.createElement("div");
        item.className="cartItem";
        item.innerHTML = `
          <div style="min-width:0;">
            <p class="name">${product.name}</p>
            <p class="meta">${product.category} · ${product.id} · 단가 ${fmt(product.price)}원</p>
          </div>
          <div style="text-align:right;">
            <div class="mini">
              <button class="miniBtn" type="button" data-minus="${id}">−</button>
              <div class="miniQty">${qty}</div>
              <button class="miniBtn" type="button" data-plus="${id}">+</button>
            </div>
            <div style="margin-top:6px;font-weight:900;">${fmt(product.price*qty)}원</div>
          </div>
        `;
        wrap.appendChild(item);
      }

      wrap.querySelectorAll("[data-minus]").forEach(b=>{
        b.onclick = ()=>changeQty(b.dataset.minus, -1);
      });
      wrap.querySelectorAll("[data-plus]").forEach(b=>{
        b.onclick = ()=>changeQty(b.dataset.plus, +1);
      });
    }

    /* 주소검색: 팝업 대신 embed */
    function openAddressSearchEmbed(){
      const help = el("addrHelp");
      help.textContent = "";

      if (!window.daum || !daum.Postcode){
        help.textContent = "주소 검색 서비스를 불러오지 못했습니다. (사내망에서 차단되었을 수 있어요) 우편번호/주소를 수동 입력으로 전환해야 합니다.";
        toast("주소검색 로드 실패");
        return;
      }

      const layer = el("addrLayer");
      layer.classList.add("open");

      new daum.Postcode({
        oncomplete: function(data){
          const addr = data.roadAddress || data.jibunAddress || "";
          el("zip").value = data.zonecode || "";
          el("addr1").value = addr;
          layer.classList.remove("open");
          el("addr2").focus();

          recalcShipping();
          validateStepButtons();
        },
        onresize: function(size){
          layer.style.height = Math.max(380, size.height) + "px";
        },
        width: "100%",
        height: "100%"
      }).embed(layer);
    }

    function buildPayload(){
      const items = [];
      for (const {product, qty} of state.cart.values()){
        items.push({
          id: product.id,
          category: product.category,
          name: product.name,
          unit_price: product.price,
          qty,
          line_total: product.price * qty
        });
      }
      const now = new Date();
      const orderId = `ORD-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${now.getTime().toString().slice(-6)}`;

      return {
        order_id: orderId,
        created_at: now.toISOString(),
        orderer: {
          name: el("ordererName").value.trim(),
          emp_id: el("ordererEmpId").value.trim(),
          phone: el("ordererPhone").value.trim(),
          dept: el("ordererDept").value.trim()
        },
        recipient: {
          name: el("recvName").value.trim(),
          phone: el("recvPhone").value.trim(),
          address: {
            zip: el("zip").value.trim(),
            addr1: el("addr1").value.trim(),
            addr2: el("addr2").value.trim()
          }
        },
        shipping: { method: "택배발송", fee: state.shipFee, reason: state.shipFeeReason },
        note: el("note").value.trim(),
        items,
        items_total: calcItemsTotal(),
        grand_total: calcGrandTotal()
      };
    }

    function openSummary(){
      const payload = buildPayload();

      const kv = el("summaryKV");
      kv.innerHTML = "";
      const rows = [
        ["주문번호", payload.order_id],
        ["요청일시", new Date(payload.created_at).toLocaleString("ko-KR")],
        ["주문자", `${payload.orderer.name} (${payload.orderer.dept})`],
        ["사번", payload.orderer.emp_id || "-"],
        ["주문자 연락처", payload.orderer.phone || "-"],
        ["수령자", payload.recipient.name],
        ["수령자 연락처", payload.recipient.phone],
        ["배송지", `(${payload.recipient.address.zip}) ${payload.recipient.address.addr1} ${payload.recipient.address.addr2}`],
        ["출고/배송비", `택배발송 / ${fmt(payload.shipping.fee)}원 (${payload.shipping.reason})`],
        ["비고", payload.note || "-"],
      ];
      rows.forEach(([k,v])=>{
        const kEl = document.createElement("div"); kEl.style.color="var(--muted)"; kEl.textContent = k;
        const vEl = document.createElement("div"); vEl.style.fontWeight="900"; vEl.textContent = v;
        kv.appendChild(kEl); kv.appendChild(vEl);
      });

      const body = el("summaryItems");
      body.innerHTML = "";
      payload.items.forEach(it=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.category}</td>
          <td>${it.name}</td>
          <td style="text-align:right;">${fmt(it.unit_price)}원</td>
          <td style="text-align:right;">${fmt(it.qty)}</td>
          <td style="text-align:right;">${fmt(it.line_total)}원</td>
        `;
        body.appendChild(tr);
      });

      el("summaryItemsTotal").textContent = `${fmt(payload.items_total)}원`;
      el("summaryShipFee").textContent = `${fmt(payload.shipping.fee)}원`;
      el("summaryGrandTotal").textContent = `${fmt(payload.grand_total)}원`;

      el("sendStatus").className = "status";
      el("sendStatus").textContent = "전송 대기";

      el("copyJsonBtn").onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
          toast("JSON을 복사했습니다");
        }catch{
          toast("복사 실패: 브라우저 권한 확인");
        }
      };

      el("confirmSendBtn").disabled = false;
      el("confirmSendBtn").onclick = ()=>submit(payload);

      el("summaryBackdrop").classList.add("open");
      el("summaryBackdrop").setAttribute("aria-hidden","false");
    }

    function closeSummary(){
      el("summaryBackdrop").classList.remove("open");
      el("summaryBackdrop").setAttribute("aria-hidden","true");
    }

    async function submit(payload){
      const st = el("sendStatus");
      const btn = el("confirmSendBtn");

      st.className="status"; st.textContent="전송 중...";
      btn.disabled = true;

      if(!WEB_APP_URL){
        console.log("ORDER_PAYLOAD:", payload);
        st.className="status ok"; st.textContent="제출 완료";
        toast("제출 완료");
        resetAfterSubmit();
        return;
      }

      try{
        const res = await fetch(WEB_APP_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data.ok){
          st.className="status ok"; st.textContent="제출 완료";
          toast("제출 완료");
          resetAfterSubmit();
        }else{
          st.className="status err"; st.textContent="제출 실패";
          toast("제출 실패");
          console.error("submit failed:", data);
          btn.disabled = false;
        }
      }catch(e){
        st.className="status err"; st.textContent="제출 실패";
        toast("네트워크/권한 문제");
        console.error(e);
        btn.disabled = false;
      }
    }

    function resetAfterSubmit(){
      state.cart.clear();
      renderCartForStep4();
      renderCartPreview();

      // 입력 초기화(원하면 주문자/수령자도 초기화 가능)
      el("note").value = "";

      // 배송정보/배송비 초기화
      el("zip").value = "";
      el("addr1").value = "";
      el("addr2").value = "";
      state.shipFee = SHIPPING_BASE_FEE;
      state.shipFeeReason = "기본 무료배송";

      renderTotals();
      validateStepButtons();
      closeSummary();
      setStep(1);
    }

    function initGate(){
      el("agreeChk").addEventListener("change", e=>{
        el("startBtn").disabled = !e.target.checked;
      });
      el("startBtn").onclick = ()=>{
        el("gateBackdrop").classList.remove("open");
        el("gateBackdrop").setAttribute("aria-hidden","true");
        el("app").style.display = "";
        toast("동의 확인 완료");
      };
    }

    function init(){
      initGate();

      // Step navigation
      el("toStep2").onclick = ()=>setStep(2);
      el("toStep3").onclick = ()=>setStep(3);
      el("toStep4").onclick = ()=>setStep(4);
      el("backTo1").onclick = ()=>setStep(1);
      el("backTo2").onclick = ()=>setStep(2);
      el("backTo3").onclick = ()=>setStep(3);

      // Cart
      el("clearCartBtn").onclick = clearCart;

      // Form input validation
      [
        "ordererName","ordererEmpId","ordererPhone","ordererDept",
        "recvName","recvPhone","zip","addr1","addr2","note"
      ].forEach(id=>{
        el(id).addEventListener("input", ()=>{
          if(id==="zip") recalcShipping();
          validateStepButtons();
        });
      });

      // Address
      el("addrSearchBtn").onclick = openAddressSearchEmbed;

      // Submit flow
      el("submitBtn").onclick = openSummary;
      el("closeSummaryBtn").onclick = closeSummary;
      el("summaryBackdrop").addEventListener("click", e=>{
        if(e.target===el("summaryBackdrop")) closeSummary();
      });

      // Render
      renderTabs();
      renderProducts();
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
    }

    init();
  </script>
</body>
</html>
