<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>임직원 구매 신청</title>
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#111827; --danger:#b91c1c; --ok:#065f46; --shadow: 0 10px 30px rgba(17,24,39,.08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","맑은 고딕",Arial,sans-serif;background:var(--bg);color:var(--text);}
    .container{max-width:1080px;margin:0 auto;padding:22px 14px 48px;}
    header{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;margin-bottom:14px;}
    h1{margin:0;font-size:20px;letter-spacing:-.2px;}
    .subtitle{margin:6px 0 0;font-size:12.5px;line-height:1.45;color:var(--muted);}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--line);background:#fff;border-radius:999px;font-size:12px;color:var(--muted);box-shadow:0 2px 10px rgba(17,24,39,.04);white-space:nowrap;}
    .pill b{color:var(--text)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .cardBody{padding:14px 16px;}
    .muted{color:var(--muted)}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-size:13px;}
    .btn.primary{background:#111827;border-color:#111827;color:#fff;}
    .btn:disabled{opacity:.55;cursor:not-allowed;}
    .btn.danger{border-color:#fecaca;color:var(--danger);background:#fff;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .divider{border:none;border-top:1px solid var(--line);margin:14px 0;}
    .stepper{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 14px;}
    .step{flex:1;min-width:140px;border:1px solid var(--line);background:#fff;border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:flex-start;}
    .stepNum{width:28px;height:28px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;font-weight:900;font-size:12px;color:var(--muted);}
    .step.active{border-color:#111827}
    .step.active .stepNum{border-color:#111827;color:#111827}
    .stepTitle{font-weight:900;font-size:13px;letter-spacing:-.1px;margin:0}
    .stepDesc{margin:4px 0 0;font-size:12px;color:var(--muted);line-height:1.35}
    .section{display:none}
    .section.active{display:block}

    .step1Grid{display:grid;grid-template-columns: 1.55fr .95fr; gap:12px; align-items:start;}
    @media (max-width:960px){.step1Grid{grid-template-columns:1fr}}
    .panel{border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden;}
    .panelHeader{padding:12px 12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .panelHeader h3{margin:0;font-size:13px;letter-spacing:-.1px;}
    .panelBody{padding:12px 12px;}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);white-space:nowrap;}
    .badge strong{color:var(--text)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;font-size:13px;cursor:pointer;}
    .tab.active{background:#111827;border-color:#111827;color:#fff;}

    .products{display:grid;grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));gap:10px;}
    @media (max-width:520px){.products{ grid-template-columns: 1fr; }}

    .product{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px;min-width:0;}
    .productTop{display:flex;flex-direction:column;gap:10px;align-items:stretch;}
    .thumb{position:relative;width:100%;height:160px;border-radius:14px;border:1px solid var(--line);background:#f9fafb;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:10px;}
    .thumb img{max-width:100%;max-height:100%;width:auto;height:auto;object-fit:contain;object-position:center;display:block;}
    .thumb .ph{font-size:12px;color:var(--muted);font-weight:900}

    .productInfo{min-width:0;}
    .productName{margin:0;font-weight:900;font-size:13.5px;letter-spacing:-.1px;line-height:1.25;word-break:keep-all;overflow-wrap:break-word;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;overflow:hidden;}
    .productId{margin:4px 0 0;font-size:12px;color:var(--muted);font-weight:800;}
    .productMeta{margin:8px 0 0;font-size:12px;color:var(--muted);line-height:1.45;word-break:keep-all;overflow-wrap:break-word;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:3;overflow:hidden;}
    .expiry{color:#b91c1c;font-weight:900;}

    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);white-space:nowrap;}
    .chip.off{border-color:#1118271f;color:#111827;background:#f9fafb;}
    .chip.soldout{border-color:#fecaca;color:#b91c1c;background:#fff1f2;}
    .product.isSoldout{opacity:.82;}

    .priceLine{margin-top:6px;display:flex;justify-content:flex-end;font-weight:900;white-space:nowrap;}

    .qty{width:86px;padding:8px 10px;border:1px solid var(--line);border-radius:12px;font-size:14px;outline:none;}
    .miniHint{font-size:12px;color:var(--muted);line-height:1.4;margin-top:4px;}

    .qtyBadge{position:absolute;right:10px;bottom:10px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;background:#111827;color:#fff;border:1px solid rgba(255,255,255,.35);box-shadow:0 10px 24px rgba(17,24,39,.22);}
    .qtyBadge.red{background:#b91c1c;}

    .cartList{display:flex;flex-direction:column;gap:10px;}
    .cartItem{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff;display:flex;justify-content:space-between;gap:10px;min-width:0;}
    .cartItem .name{margin:0;font-weight:900;font-size:13px;max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;}
    .cartItem .meta{margin:6px 0 0;font-size:12px;color:var(--muted);line-height:1.35;}
    .mini{display:flex;gap:6px;align-items:center;justify-content:flex-end;}
    .miniBtn{width:30px;height:30px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:900;display:grid;place-items:center;}
    .miniBtn:disabled{opacity:.45;cursor:not-allowed;}
    .miniQty{min-width:26px;text-align:center;font-weight:900;font-size:13px;}
    .sumBox{border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:#fff;}
    .sumRow{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin:6px 0;}
    .sumRow strong{font-weight:900}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
    input[type="text"], input[type="tel"], textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:14px;outline:none;background:#fff;}
    textarea{min-height:90px;resize:vertical;}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:520px){.form{grid-template-columns:1fr}}
    .help{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}

    .backdrop{position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .backdrop.open{display:flex;}
    .modal{width:min(920px,100%);background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:0 18px 60px rgba(17,24,39,.22);overflow:hidden;display:flex;flex-direction:column;max-height:86vh;}
    .modalHeader{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex:0 0 auto;}
    .modalHeader h3{margin:0;font-size:15px;letter-spacing:-.1px;}
    .modalBody{padding:14px 16px;overflow:auto;flex:1 1 auto;}
    .modalFooter{padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;align-items:center;gap:10px;background:#fff;flex:0 0 auto;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;word-break:keep-all;overflow-wrap:break-word;}
    th{font-size:12px;color:var(--muted);font-weight:900;}
    .tfoot td{font-weight:900;border-bottom:none;padding-top:12px;}
    .status{font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--muted);white-space:nowrap;}
    .status.ok{border-color:#bbf7d0;color:var(--ok);background:#f0fdf4;}
    .status.err{border-color:#fecaca;color:var(--danger);background:#fff1f2;}

    .policy{font-size:12px;line-height:1.6;background:#f9fafb;border:1px solid var(--line);border-radius:14px;padding:12px;max-height:260px;overflow:auto;}
    .checkRow{display:flex;gap:10px;align-items:flex-start;margin-top:12px;}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-size:13px;box-shadow:0 12px 30px rgba(17,24,39,.22);opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;z-index:60;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px);}

    .addrLayer{display:none;border:1px solid var(--line);border-radius:14px;overflow:hidden;height:420px;background:#fff;margin-top:10px;}
    .addrLayer.open{display:block;}

    .accountBox{border:1px solid var(--line);border-radius:14px;background:#f9fafb;padding:12px;}
    .accountBox .title{font-weight:900;margin:0 0 6px;}
    .accountBox .text{margin:0;color:var(--muted);font-size:12.5px;line-height:1.55;}
    .kvs{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;font-size:13px;line-height:1.35;}
    @media (max-width:520px){.kvs{grid-template-columns:1fr}}

    .cartPreviewEmpty{font-size:12px;color:var(--muted);line-height:1.5;}

    .closedBanner{
      padding:10px 12px;margin-bottom:10px;border:1px solid #fecaca;background:#fff1f2;border-radius:12px;
      color:#b91c1c;font-weight:900;
    }
  </style>
</head>

<body>
  <div class="container" id="app" style="display:none;">
    <header>
      <div>
        <h1>2026 설맞이 임직원 구매 신청</h1>
        <p class="subtitle">관리자 승인 후 <b>택배로만</b> 발송됩니다. 기본 배송비는 <b>무료</b>이며, <b>제주/도서산간</b>은 우편번호 기준으로 추가배송비가 적용될 수 있습니다.</p>
      </div>
      <div class="pill" id="topPill">출고: <b>택배발송</b> · 배송비: <b id="topShipFee">0원</b></div>
    </header>

    <div class="stepper">
      <div class="step active" id="step1"><div class="stepNum">1</div><div><p class="stepTitle">상품 선택</p><p class="stepDesc">카테고리에서 담기</p></div></div>
      <div class="step" id="step2"><div class="stepNum">2</div><div><p class="stepTitle">주문자 정보</p><p class="stepDesc">요청자 입력</p></div></div>
      <div class="step" id="step3"><div class="stepNum">3</div><div><p class="stepTitle">수령자/주소</p><p class="stepDesc">배송 정보 입력</p></div></div>
      <div class="step" id="step4"><div class="stepNum">4</div><div><p class="stepTitle">최종 확인</p><p class="stepDesc">요약 후 제출</p></div></div>
    </div>

    <div class="card">
      <div class="cardBody">

        <div class="section active" id="section1">
          <div class="row" style="justify-content:space-between;">
            <div>
              <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">상품 선택</h2>
              <div class="muted" style="font-size:12px;margin-top:6px;">
                카테고리에서 담고, 오른쪽 장바구니에서 수량을 조절하세요.
                (기본 최대 <b id="maxQtyText"></b>개, 일부 품목은 1개 제한)
                <br> 제품 사진을 클릭하면 세부 설명을 확인할 수 있습니다.
              </div>
            </div>
            <button class="btn danger" id="clearCartBtn" disabled>장바구니 비우기</button>
          </div>

          <div class="divider"></div>

          <div class="step1Grid">
            <div class="panel">
              <div class="panelHeader">
                <h3>상품 목록</h3>
                <span class="badge">배송비 <strong id="badgeShipFee">0원</strong></span>
              </div>
              <div class="panelBody">
                <div class="tabs" id="tabs"></div>
                <div class="products" id="products"></div>
              </div>
            </div>

            <div class="panel">
              <div class="panelHeader">
                <h3>장바구니</h3>
                <span class="badge">담긴 상품 <strong id="cartCount">0</strong></span>
              </div>
              <div class="panelBody">
                <div id="cartPreview"></div>

                <div class="divider"></div>

                <div class="sumBox">
                  <div class="sumRow"><span class="muted">상품 합계</span><strong id="itemsTotal">0원</strong></div>
                  <div class="sumRow"><span class="muted">배송비</span><strong id="shipFeeLine">0원</strong></div>
                  <div class="sumRow"><span>총 결제금액(실결제 없음)</span><strong id="grandTotal">0원</strong></div>
                  <div class="miniHint" id="shipReason" style="margin-top:8px;"></div>
                  <div class="miniHint" id="minOrderHint" style="margin-top:6px;"></div>
                </div>

                <div class="divider"></div>

                <div class="row" style="justify-content:flex-end;">
                  <button class="btn primary" id="toStep2" disabled>다음</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section" id="section2">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">주문자(요청자) 정보</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">주문은 회사 사람이 해도, 수령자는 가족/지인으로 설정 가능합니다.</div>

          <div class="divider"></div>

          <div class="form">
            <div>
              <label>주문자 이름(입금자) *</label>
              <input type="text" id="ordererName" placeholder="예) 홍길동">
            </div>
            <div>
              <label>사번(직원번호) *</label>
              <input type="text" id="ordererEmpId" placeholder="예) 123456">
            </div>
            <div>
              <label>주문자 연락처 *</label>
              <input type="tel" id="ordererPhone" placeholder="예) 010-1234-5678">
            </div>
            <div>
              <label>사업장/부서 *</label>
              <input type="text" id="ordererDept" placeholder="예) 국내사업본부/영업지원팀">
            </div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo1">이전</button>
            <button class="btn primary" id="toStep3" disabled>다음</button>
          </div>
        </div>

        <div class="section" id="section3">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">수령자(배송 정보)</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">우편번호 기준으로 제주/도서산간 추가배송비가 자동 적용됩니다.</div>

          <div class="divider"></div>
          <div class="row" style="margin:0 0 10px;">
            <label style="margin:0;display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:800;">
              <input type="checkbox" id="sameAsOrdererChk">
              주문자 정보와 동일(이름/연락처)
            </label>
            <span class="muted" style="font-size:12px;">(체크하면 자동 입력됩니다)</span>
          </div>

          <div class="form">
            <div>
              <label>수령인 이름 *</label>
              <input type="text" id="recvName" placeholder="예) 김철수">
            </div>
            <div>
              <label>수령인 연락처 *</label>
              <input type="tel" id="recvPhone" placeholder="예) 010-0000-0000">
            </div>

            <div>
              <label>우편번호 *</label>
              <input type="text" id="zip" readonly placeholder="주소 검색으로 자동입력">
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="addrSearchBtn" type="button" style="width:100%;">주소 검색</button>
            </div>

            <div style="grid-column:1 / -1;">
              <label>기본주소(도로명/지번) *</label>
              <input type="text" id="addr1" readonly placeholder="주소 검색으로 자동입력">
            </div>
            <div style="grid-column:1 / -1;">
              <label>상세주소 *</label>
              <input type="text" id="addr2" placeholder="예) 101동 1203호">
            </div>
          </div>

          <div class="addrLayer" id="addrLayer"></div>
          <div class="help" id="addrHelp"></div>

          <div class="divider"></div>

          <div class="sumBox">
            <div class="sumRow"><span class="muted">현재 배송비</span><strong id="shipFeeNow">0원</strong></div>
            <div class="miniHint" id="shipReasonNow"></div>
          </div>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo2">이전</button>
            <button class="btn primary" id="toStep4" disabled>다음</button>
          </div>
        </div>

        <div class="section" id="section4">
          <h2 style="margin:0;font-size:15px;letter-spacing:-.1px;">최종 확인</h2>
          <div class="muted" style="font-size:12px;margin-top:6px;">요약을 확인하고 제출하세요.</div>

          <div class="divider"></div>

          <div class="cartList" id="cartList"></div>

          <div class="divider"></div>

          <div class="sumBox">
            <div class="sumRow"><span class="muted">상품 합계</span><strong id="itemsTotal2">0원</strong></div>
            <div class="sumRow"><span class="muted">배송비</span><strong id="shipFeeLine2">0원</strong></div>
            <div class="sumRow"><span>총 결제금액(배송비 포함)</span><strong id="grandTotal2">0원</strong></div>
            <div class="miniHint" id="shipReason2" style="margin-top:8px;"></div>
          </div>

          <div class="divider"></div>

          <div class="accountBox">
            <p class="title">입금 안내</p>
            <p class="text">
              아래 계좌로 입금해주세요.<br>
              <b>입금계좌: 우리은행/ 2656-3515-618154/ 개인구매 주식회사 도루코</b><br>
              <b>입금자는 주문자와 동일해야 합니다.</b><br>
            </p>
          </div>

          <div class="divider"></div>

          <label>비고</label>
          <textarea id="note" placeholder="예) 문 앞에 놓아주세요 / 부재 시 연락 부탁드립니다."></textarea>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between;">
            <button class="btn" id="backTo3">이전</button>
            <button class="btn primary" id="submitBtn">제출 전 요약 보기</button>
          </div>

          <div class="help">제출 후에는 관리자(영업지원부서)가 승인 절차를 진행합니다.</div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="backdrop open" id="gateBackdrop" aria-hidden="false">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
      <div class="modalHeader">
        <h3 id="gateTitle">주문 전 필수 안내</h3>
        <span class="status err" id="gateStatus">스크롤 확인 필요</span>
      </div>
      <div class="modalBody">
        <div class="policy" id="policyBox">
          <div class="closedBanner" id="closedBanner" style="display:none;"></div>

<b>[필수 확인 사항]</b><br><br>

1) 본 사내구매는 <b>재판매 또는 영리 목적 사용은 금지</b>되어 있습니다.<br> 
2) 세법에 의해 사내구매 연간 구매금액은  <b>200만원 이내로 제한</b>됩니다.<br> 
3) 신청한 물품은 내부 기준에 따라 <b>승인 또는 반려</b>될 수 있습니다.<br>
4) 출고는 <b>택배 발송</b>이며 기본 무료이나, 우편번호 기준 <b>제주/도서산간</b> 지역은 추가 배송비가 발생할 수 있습니다.<br>
5) 수령자, 주소, 연락처 오류로 인한 배송 문제는 재발송이 제한될 수 있습니다.<br>
6) 입력 정보는 주문 처리 목적에 한해 사용됩니다.<br><br>

위 내용을 확인했으며, 정확한 정보를 입력하겠습니다.<br><br>

<hr>

<b>[개인정보 수집 및 이용 동의]</b><br><br>

주식회사 도루코(이하 “회사”)는 「개인정보보호법」 제15조 제1항에 따라 아래와 같이 개인정보를 수집·이용합니다.<br>
단, 계약이 체결되지 않은 경우 수집된 개인정보는 즉시 파기됩니다.<br><br>

<b>1. 수집 항목</b><br>
- 성명, 사번, 주소, 연락처(휴대전화번호 등)<br>
- 상품 구매정보, 배송 정보(수령인명, 주소 등)<br><br>

<b>2. 이용 목적</b><br>
- 주문 처리 및 본인 의사 확인<br>
- 고객 상담 및 부정 이용 방지<br>
- 물품 배송 및 안내 사항 전달<br><br>

<b>3. 보유 기간</b><br>
- 개인정보는 이용 목적 달성 시까지 보관 후 즉시 삭제됩니다.<br><br>

귀하는 개인정보 제공을 거부할 권리가 있으며, 거부 시 주문이 제한될 수 있습니다.<br><br>

<b>※ 아래까지 스크롤하여 전체 내용을 확인해주세요.</b>
        </div>

        <div class="checkRow">
          <input type="checkbox" id="agreeChk" disabled>
          <div>
            <b>위 안내사항을 모두 읽었고 동의합니다.</b><br>
            <span class="muted" style="font-size:12px;">스크롤 완료 후 체크가 활성화됩니다.</span>
          </div>
        </div>
      </div>
      <div class="modalFooter">
        <button class="btn primary" id="startBtn" disabled>시작하기</button>
      </div>
    </div>
  </div>

  <div class="backdrop" id="summaryBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="summaryTitle">
      <div class="modalHeader">
        <h3 id="summaryTitle">제출 요약</h3>
        <button class="btn" id="closeSummaryBtn">닫기</button>
      </div>

      <div class="modalBody">
        <div class="card" style="box-shadow:none;">
          <div class="cardBody" style="padding:12px;">
            <div class="kvs" id="summaryKV"></div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;margin-top:10px;">
          <div class="cardBody" style="padding:12px;">
            <table>
              <thead>
                <tr>
                  <th>카테고리</th>
                  <th>상품</th>
                  <th style="text-align:right;">단가</th>
                  <th style="text-align:right;">수량</th>
                  <th style="text-align:right;">합계</th>
                </tr>
              </thead>
              <tbody id="summaryItems"></tbody>
              <tfoot>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">상품 합계</td>
                  <td id="summaryItemsTotal" style="text-align:right;"></td>
                </tr>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">배송비</td>
                  <td id="summaryShipFee" style="text-align:right;"></td>
                </tr>
                <tr class="tfoot">
                  <td colspan="4" style="text-align:right;">총 결제금액(실결제 없음)</td>
                  <td id="summaryGrandTotal" style="text-align:right;"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="help">시스템 상 입금 후에는 취소 및 환불이 어려울 수 있습니다. 신중히 결정 후 입금 바랍니다.</div>
      </div>

      <div class="modalFooter">
        <span class="status" id="sendStatus">전송 대기</span>
        <button class="btn" id="copyJsonBtn" style="display:none;">JSON 복사</button>
        <button class="btn primary" id="confirmSendBtn">최종 제출</button>
      </div>
    </div>
  </div>

  <script>
    const ORDER_CLOSED = true;
    const ORDER_CLOSED_MSG = "현재 주문이 마감되었습니다. (2026 설맞이 임직원 구매 신청 종료)";

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzm2Yjy6K5hj8o79IL-_YTgMyD7VTi9VO0JJEfhOzo42rHOhOhTAMpeOPO5chpggPLW/exec";

    const MIN_ORDER_AMOUNT = 20000;

    const MAX_QTY_PER_ITEM = 100;
    const ITEM_MAX_QTY = { "KT-02": 1 };
    const getItemMaxQty = (productId)=> ITEM_MAX_QTY[productId] ?? MAX_QTY_PER_ITEM;

    const SHIPPING_BASE_FEE = 0;
    const SHIPPING_JEJU_FEE = 3000;
    const SHIPPING_ISLAND_FEE = 5000;

    const ZIP_RULES = [
      { type: "jeju", ranges: [[63000, 63644]] },
      { type: "island", ranges: [
        [22386, 22388],[23004, 23010],[23100, 23116],[23124, 23136],[31708, 31708],[32133, 32133],[33411, 33411],
        [40200, 40240],[46768, 46771],[52570, 52571],[53031, 53033],[53089, 53104],[54000, 54000],[56347, 56349],
        [57068, 57069],[58760, 58762],[58800, 58810],[58816, 58818],[28826, 28826],[58828, 58866],[58953, 58958],
        [59102, 59103],[59106, 59106],[59127, 59127],[59129, 59129],[59137, 59166],[59650, 59650],[59766, 59766],
        [59781, 59790],
      ]},
    ];

    const CATEGORIES = [
      { key: "면도기", label: "면도기" },
      { key: "주방용품", label: "주방용품" },
      { key: "쿡웨어", label: "쿡웨어" },
    ];

    const PRODUCTS = [
      { id:"RZ-01", category:"면도기", name:"터치3 휴대용면도기 2입", price:4000, desc:"2입 x 20개 구성", detail:"", longDesc:"Touch3 휴대용 면도기 2입", image:"RZ-01.jpg", discount: 88, soldOut: false, packQty: "x20" },
      { id:"RZ-02", category:"면도기", name:"페이스6 골드기획 2호", price:10000, desc:"10SET 구성", detail:"", longDesc:"1) PACE6 면도기(날포함) 1ea\n2) PACE6 면도날 4ea\n\nPACE시스템 전제품 호환 가능", image:"RZ-02.jpg", discount: 90, soldOut: false, packQty: "x10" },
      { id:"RZ-03", category:"면도기", name:"페이스3D 모션 홈쇼핑기획 4호 1+1", price:10000, desc:"폼 유통기한: 26년 4월", detail:"", longDesc:"1) 3D모션 면도기(날포함) 1ea\n2) 3D모션 면도날 11ea\n3) 네이비 스탠드 1ea\n4) PACE 아쿠아 쉐이빙폼 250ml 1ea\n\n폼 유통기한: 26년 4월", image:"RZ-03.jpg", discount: 92, soldOut: false, packQty: "1+1" },
      { id:"RZ-04", category:"면도기", name:"이브 크리미 기획세트 2호 1+1", price:5000, desc:"", detail:"폼 유통기한: 26년 4월", longDesc:"1) 이브 크리미 면도기(날포함) 1ea\n2) 샤이 크리미 면도날 1ea\n3) 샤이 심플 눈썹면도기 3ea\n4) 샤이 비키니 면도기 1ea\n5) 페이스 프레쉬 폼 250ml 1ea\n\n폼 유통기한: 26년 4월", image:"RZ-04.jpg", discount: 90, soldOut: false, packQty: "1+1" },
      { id:"RZ-05", category:"면도기", name:"슬릭모션 온라인 기획세트1호", price:25000, desc:"", detail:"", longDesc:"1) 슬릭모션 면도기(날포함) 1ea\n2) 면도날 9ea", image:"RZ-05.jpg", discount: 54, soldOut: false },

      { id:"KT-01", category:"주방용품", name:"인테리어 라임 기획세트 1호", price:25000, desc:"-", detail:"", longDesc:"1) 인테리어 다용도식도 190mm(라임) 1ea\n2) 인테리어 야채용식도 170mm(라임) 1ea\n3) 인테리어 과도 120mm(라임) 1ea\n4) 인테리어 가위 110S(라임) 1ea", image:"KT-01.jpg", discount: 74, soldOut: false },
      { id:"KT-02", category:"주방용품", name:"뉴클래식 라이트 특판세트 1호 1+1", price:20000, desc:"한정판매 85세트", detail:"1인 1개 한정 판매", longDesc:"1) 베이직 가위 120S 1ea\n2) 뉴클래식라이트 다용도식도 200mm 1ea\n3) 뉴클래식 라이트 야채용식도 165mm 1ea\n\n★한정판매 85세트", image:"KT-02.jpg", discount: 85, soldOut: true, packQty: "1+1" },
      { id:"KT-03", category:"주방용품", name:"클래식 키친툴 4종 세트", price:10000, desc:"한정판매 280세트", detail:"", longDesc:"1) 클래식 삼각 뒤지개 1ea\n2) 클래식 면국자 1ea\n3) 클래식 요리스푼(중) 1ea\n4) 클래식 뒤지개 1ea\n\n★한정판매 280세트", image:"KT-03.jpg", discount: 79, soldOut: false },
      { id:"KT-04", category:"주방용품", name:"클래식 키친툴 3종 세트", price:3000, desc:"-", detail:"", longDesc:"1) 클래식 삼각 뒤지개 1ea\n2) 클래식 면국자 1ea\n3) 클래식 요리스푼(중) 1ea", image:"KT-04.jpg", discount: 91, soldOut: false },

      { id:"CW-01", category:"쿡웨어", name:"포레스타 시즌3 IH 7종세트", price:50000, desc:"-", detail:"", longDesc:"1) 포레스타 IH 편수 20cm 1ea\n2) 포레스타 IH 프라이팬 28cm 2ea\n3) 포레스타 IH 궁중팬 26cm 1ea\n4) 포레스타 IH 전골팬 26cm 1ea\n5) 유리뚜껑 20cm 1ea\n6) 유리뚜껑 26cm 1ea\n7) 증정품 귀리쌀 (포장일 2023년)", image:"CW-01.jpg", discount: 69, soldOut: false },
      { id:"CW-02", category:"쿡웨어", name:"애쉬블루 IH 프라이팬 2종 세트 1호", price:10000, desc:"", detail:"박스 미세흠집 가능", longDesc:"1) 애쉬블루 프라이팬 24cm 1ea\n2) 애쉬블루 프라이팬 28cm 1ea \n본 상품은 특가 판매 상품으로, 박스 상태에 경미한 흠집이나 눌림이 있을 수 있으며, 해당 사유로 교환/반품은 어렵습니다.", image:"CW-02.jpg", discount: 83, soldOut: true },
    ];

    const state = {
      activeCategory: CATEGORIES[0].key,
      cart: new Map(),
      shipFee: SHIPPING_BASE_FEE,
      shipFeeReason: "기본 무료배송",
      policyRead: false
    };

    const el = (id) => document.getElementById(id);
    const fmt = (n) => new Intl.NumberFormat("ko-KR").format(n);

    function toast(msg){
      const t = el("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1600);
    }

    const zipToInt = (zip)=>{
      const n = parseInt(String(zip || "").replace(/\D/g, ""), 10);
      return Number.isFinite(n) ? n : null;
    };
    const matchZip = (zipInt, ranges)=> ranges.some(([s,e])=> zipInt>=s && zipInt<=e);

    function shippingByZip(zip){
      const z = zipToInt(zip);
      if (z === null) return { fee: SHIPPING_BASE_FEE, reason: "기본 무료배송" };

      const jejuRule = ZIP_RULES.find(r => r.type === "jeju");
      if (jejuRule && matchZip(z, jejuRule.ranges)) return { fee: SHIPPING_JEJU_FEE, reason: "제주 추가배송비" };

      const islandRule = ZIP_RULES.find(r => r.type === "island");
      if (islandRule && matchZip(z, islandRule.ranges)) return { fee: SHIPPING_ISLAND_FEE, reason: "도서산간 추가배송비" };

      return { fee: SHIPPING_BASE_FEE, reason: "기본 무료배송" };
    }

    const calcItemsTotal = ()=> {
      let total = 0;
      for (const {product, qty} of state.cart.values()) total += product.price * qty;
      return total;
    };
    const calcGrandTotal = ()=> calcItemsTotal() + state.shipFee;
    const minOrderOk = ()=> calcItemsTotal() >= MIN_ORDER_AMOUNT;

    function setStep(active){
      ["1","2","3","4"].forEach(n=>{
        el("step"+n).classList.toggle("active", n===String(active));
        el("section"+n).classList.toggle("active", n===String(active));
      });
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function validateStepButtons(){
      const itemsTotal = calcItemsTotal();
      const minOk = itemsTotal >= MIN_ORDER_AMOUNT;

      el("toStep2").disabled = !(state.cart.size > 0 && minOk);

      const ordererOk =
        el("ordererName").value.trim() &&
        el("ordererEmpId").value.trim() &&
        el("ordererPhone").value.trim() &&
        el("ordererDept").value.trim();

      el("toStep3").disabled = !(state.cart.size > 0 && minOk && ordererOk);

      const recvOk = el("recvName").value.trim() && el("recvPhone").value.trim();
      const addrOk = el("zip").value.trim() && el("addr1").value.trim() && el("addr2").value.trim();
      el("toStep4").disabled = !(state.cart.size > 0 && minOk && ordererOk && recvOk && addrOk);

      el("clearCartBtn").disabled = !(state.cart.size > 0);
      el("submitBtn").disabled = !(state.cart.size > 0 && minOk);
    }

    function recalcShipping(){
      const ship = shippingByZip(el("zip").value);
      state.shipFee = ship.fee;
      state.shipFeeReason = ship.reason;
      renderTotals();
      validateStepButtons();
    }

    function renderTabs(){
      const wrap = el("tabs");
      wrap.innerHTML = "";
      for (const c of CATEGORIES){
        const b = document.createElement("button");
        b.className = "tab" + (c.key === state.activeCategory ? " active" : "");
        b.textContent = c.label;
        b.onclick = ()=>{ state.activeCategory = c.key; renderTabs(); renderProducts(); };
        wrap.appendChild(b);
      }
    }

    const getDiscountChipText = (p)=>{
      const d = Number(p.discount);
      return Number.isFinite(d) && d > 0 ? `${d}% 할인` : "";
    };

    function renderProducts(){
      const wrap = el("products");
      wrap.innerHTML = "";
      const list = PRODUCTS.filter(p=>p.category===state.activeCategory);

      for (const p of list){
        const card = document.createElement("div");
        card.className = "product";

        const top = document.createElement("div");
        top.className = "productTop";

        const thumb = document.createElement("div");
        thumb.className = "thumb";

        if (p.image){
          const img = document.createElement("img");
          img.src = p.image;
          img.alt = p.name;
          img.loading = "lazy";
          img.style.cursor = "pointer";
          img.onerror = () => { thumb.innerHTML = `<div class="ph">IMG</div>`; };
          img.onclick = ()=>openImagePreview(
            p.image,
            p.name,
            (p.longDesc || p.detail || p.desc || "").trim()
          );
          thumb.appendChild(img);

          if (p.packQty){
            const b = document.createElement("div");
            b.className = "qtyBadge red";
            b.textContent = p.packQty;
            thumb.appendChild(b);
          }
        } else {
          thumb.innerHTML = `<div class="ph">IMG</div>`;
        }

        const info = document.createElement("div");
        info.className = "productInfo";

        const name = document.createElement("p");
        name.className = "productName";
        name.textContent = p.name;

        const pid = document.createElement("p");
        pid.className = "productId";
        pid.textContent = p.id;

        info.appendChild(name);
        info.appendChild(pid);

        const chips = document.createElement("div");
        chips.className = "chips";

        const isSoldOut = (p.soldOut === true);

        if (isSoldOut){
          const s = document.createElement("span");
          s.className = "chip soldout";
          s.textContent = "SOLD OUT";
          chips.appendChild(s);
          card.classList.add("isSoldout");
        }

        const disc = getDiscountChipText(p);
        if (disc){
          const c = document.createElement("span");
          c.className = "chip off";
          c.textContent = disc;
          chips.appendChild(c);
        }

        if (chips.childElementCount > 0){
          info.appendChild(chips);
        }

        const metaParts = [p.desc, p.detail].filter(Boolean).map(s=>String(s).trim()).filter(Boolean);
        if (metaParts.length){
          const expiryParts = metaParts.filter(t => /폼\s*유통기한/i.test(t));
          const normalParts = metaParts.filter(t => !/폼\s*유통기한/i.test(t));

          const meta = document.createElement("p");
          meta.className = "productMeta";

          const normalText = normalParts.join(" · ").trim();
          if (normalText){
            const s = document.createElement("span");
            s.textContent = normalText;
            meta.appendChild(s);
          }

          if (expiryParts.length){
            if (normalText) meta.appendChild(document.createElement("br"));
            const e = document.createElement("span");
            e.className = "expiry";
            e.textContent = expiryParts.join(" / ");
            meta.appendChild(e);
          }

          info.appendChild(meta);
        }

        const priceLine = document.createElement("div");
        priceLine.className = "priceLine";
        priceLine.textContent = `${fmt(p.price)}원`;

        top.appendChild(thumb);
        top.appendChild(info);
        top.appendChild(priceLine);

        const row = document.createElement("div");
        row.className = "row";
        row.style.justifyContent = "space-between";

        const qtyWrap = document.createElement("div");
        qtyWrap.className = "row";

        const qty = document.createElement("input");
        qty.type="number";
        qty.min="1";
        qty.max=String(getItemMaxQty(p.id));
        qty.step="1";
        qty.value="1";
        qty.className="qty";
        if (isSoldOut) qty.disabled = true;

        const btn = document.createElement("button");
        btn.className="btn primary";
        btn.textContent = isSoldOut ? "품절" : "담기";
        btn.disabled = isSoldOut;

        btn.onclick = ()=>{
          const max = getItemMaxQty(p.id);
          const raw = parseInt(qty.value || "1", 10);
          const requested = Number.isFinite(raw) ? Math.max(1, raw) : 1;

          const curQty = state.cart.get(p.id)?.qty || 0;
          const addable = Math.max(0, max - curQty);

          if (addable === 0) { toast(`해당 품목은 최대 ${max}개까지 주문 가능합니다`); return; }

          const willAdd = Math.min(requested, addable);
          const msg = (requested > willAdd)
            ? `요청 ${requested}개 중 ${willAdd}개만 담겼습니다 (최대 ${max}개)`
            : "장바구니에 담았습니다";

          addToCart(p.id, willAdd, { toastMsg: msg });
        };

        qtyWrap.appendChild(qty);
        qtyWrap.appendChild(btn);
        row.appendChild(qtyWrap);

        card.appendChild(top);
        card.appendChild(row);
        wrap.appendChild(card);
      }
    }

    function addToCart(productId, qty, opts = {}){
      const product = PRODUCTS.find(x=>x.id===productId);
      if(!product) return;

      if(product.soldOut === true){ toast("품절된 상품입니다"); return; }

      const max = getItemMaxQty(productId);
      const curQty = state.cart.get(productId)?.qty || 0;
      const nextQty = Math.min(max, curQty + qty);

      if(nextQty === curQty){ toast(`해당 품목은 최대 ${max}개까지 주문 가능합니다`); return; }

      state.cart.set(productId, {product, qty: nextQty});

      toast(opts.toastMsg || "장바구니에 담았습니다");

      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
    }

    function changeQty(productId, delta){
      const p = PRODUCTS.find(x=>x.id===productId);

      if(delta > 0 && p && p.soldOut === true){ toast("품절된 상품입니다"); return; }
      if(!state.cart.has(productId)) return;

      const cur = state.cart.get(productId);
      const max = getItemMaxQty(productId);

      if (delta > 0 && cur.qty >= max){ toast(`해당 품목은 최대 ${max}개까지 주문 가능합니다`); return; }

      cur.qty += delta;

      if(cur.qty > max){ cur.qty = max; toast(`해당 품목은 최대 ${max}개까지 주문 가능합니다`); }
      if(cur.qty<=0) state.cart.delete(productId);
      else state.cart.set(productId, cur);

      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
    }

    function clearCart(){
      state.cart.clear();
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();
      toast("장바구니를 비웠습니다");
      setStep(1);
    }

    function renderTotals(){
      const itemsTotal = calcItemsTotal();
      const grandTotal = calcGrandTotal();

      el("itemsTotal").textContent = `${fmt(itemsTotal)}원`;
      el("grandTotal").textContent = `${fmt(grandTotal)}원`;
      el("itemsTotal2").textContent = `${fmt(itemsTotal)}원`;
      el("grandTotal2").textContent = `${fmt(grandTotal)}원`;

      el("shipFeeLine").textContent = `${fmt(state.shipFee)}원`;
      el("shipFeeLine2").textContent = `${fmt(state.shipFee)}원`;
      el("shipFeeNow").textContent = `${fmt(state.shipFee)}원`;
      el("topShipFee").textContent = `${fmt(state.shipFee)}원`;
      el("badgeShipFee").textContent = `${fmt(state.shipFee)}원`;

      const r = state.shipFeeReason ? `(${state.shipFeeReason})` : "";
      el("shipReason").textContent = r ? `※ ${r}` : "";
      el("shipReason2").textContent = r ? `※ ${r}` : "";
      el("shipReasonNow").textContent = r ? `※ ${r}` : "";

      const remain = Math.max(0, MIN_ORDER_AMOUNT - itemsTotal);
      el("minOrderHint").textContent =
        (itemsTotal < MIN_ORDER_AMOUNT)
          ? `※ 최소주문금액 ${fmt(MIN_ORDER_AMOUNT)}원 (현재 ${fmt(itemsTotal)}원 / ${fmt(remain)}원 더 담아주세요)`
          : `※ 최소주문금액 ${fmt(MIN_ORDER_AMOUNT)}원 충족`;
    }

    function renderCartPreview(){
      el("cartCount").textContent = String(state.cart.size);
      const wrap = el("cartPreview");
      wrap.innerHTML = "";

      if(state.cart.size===0){
        const d = document.createElement("div");
        d.className = "cartPreviewEmpty";
        d.textContent = "장바구니가 비어있습니다. 상품을 담아주세요.";
        wrap.appendChild(d);
        return;
      }

      for(const [id,{product,qty}] of state.cart.entries()){
        const max = getItemMaxQty(id);
        const plusDisabled = (qty >= max) || (product.soldOut === true);

        const item = document.createElement("div");
        item.className="cartItem";
        item.innerHTML = `
          <div style="min-width:0;">
            <p class="name">${product.name}</p>
            <p class="meta">${product.category} · ${product.id} · 단가 ${fmt(product.price)}원</p>
          </div>
          <div style="text-align:right;">
            <div class="mini">
              <button class="miniBtn" type="button" data-minus="${id}">−</button>
              <div class="miniQty">${qty}</div>
              <button class="miniBtn" type="button" data-plus="${id}" ${plusDisabled ? "disabled" : ""}>+</button>
            </div>
            <div style="margin-top:6px;font-weight:900;">${fmt(product.price*qty)}원</div>
          </div>
        `;
        wrap.appendChild(item);
      }

      wrap.querySelectorAll("[data-minus]").forEach(b=>{ b.onclick = ()=>changeQty(b.dataset.minus, -1); });
      wrap.querySelectorAll("[data-plus]").forEach(b=>{ b.onclick = ()=>changeQty(b.dataset.plus, +1); });
    }

    function renderCartForStep4(){
      const wrap = el("cartList");
      wrap.innerHTML = "";
      if(state.cart.size===0){
        const d = document.createElement("div");
        d.className="sumBox";
        d.innerHTML = `<div class="muted" style="font-size:12px;">장바구니가 비어있습니다. 1단계에서 상품을 담아주세요.</div>`;
        wrap.appendChild(d);
        return;
      }
      for(const [id,{product,qty}] of state.cart.entries()){
        const max = getItemMaxQty(id);
        const plusDisabled = (qty >= max) || (product.soldOut === true);

        const item = document.createElement("div");
        item.className="cartItem";
        item.innerHTML = `
          <div style="min-width:0;">
            <p class="name">${product.name}</p>
            <p class="meta">${product.category} · ${product.id} · 단가 ${fmt(product.price)}원</p>
          </div>
          <div style="text-align:right;">
            <div class="mini">
              <button class="miniBtn" type="button" data-minus="${id}">−</button>
              <div class="miniQty">${qty}</div>
              <button class="miniBtn" type="button" data-plus="${id}" ${plusDisabled ? "disabled" : ""}>+</button>
            </div>
            <div style="margin-top:6px;font-weight:900;">${fmt(product.price*qty)}원</div>
          </div>
        `;
        wrap.appendChild(item);
      }

      wrap.querySelectorAll("[data-minus]").forEach(b=>{ b.onclick = ()=>changeQty(b.dataset.minus, -1); });
      wrap.querySelectorAll("[data-plus]").forEach(b=>{ b.onclick = ()=>changeQty(b.dataset.plus, +1); });
    }

    function openAddressSearchEmbed(){
      const help = el("addrHelp");
      help.textContent = "";

      if (!window.daum || !daum.Postcode){
        help.textContent = "주소 검색 서비스를 불러오지 못했습니다. (사내망에서 차단되었을 수 있어요) 우편번호/주소를 수동 입력으로 전환해야 합니다.";
        toast("주소검색 로드 실패");
        return;
      }

      const layer = el("addrLayer");
      layer.classList.add("open");

      new daum.Postcode({
        oncomplete: function(data){
          const addr = data.roadAddress || data.jibunAddress || "";
          el("zip").value = data.zonecode || "";
          el("addr1").value = addr;
          layer.classList.remove("open");
          el("addr2").focus();

          recalcShipping();
          validateStepButtons();
        },
        onresize: function(size){
          layer.style.height = Math.max(380, size.height) + "px";
        },
        width: "100%",
        height: "100%"
      }).embed(layer);
    }

    function buildPayload(){
      const items = [];
      for (const {product, qty} of state.cart.values()){
        items.push({
          id: product.id,
          category: product.category,
          name: product.name,
          unit_price: product.price,
          qty,
          line_total: product.price * qty
        });
      }
      const now = new Date();
      const orderId = `ORD-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${now.getTime().toString().slice(-6)}`;

      return {
        order_id: orderId,
        created_at: now.toISOString(),
        orderer: {
          name: el("ordererName").value.trim(),
          emp_id: el("ordererEmpId").value.trim(),
          phone: el("ordererPhone").value.trim(),
          dept: el("ordererDept").value.trim()
        },
        recipient: {
          name: el("recvName").value.trim(),
          phone: el("recvPhone").value.trim(),
          address: {
            zip: el("zip").value.trim(),
            addr1: el("addr1").value.trim(),
            addr2: el("addr2").value.trim()
          }
        },
        shipping: { method: "택배발송", fee: state.shipFee, reason: state.shipFeeReason },
        note: el("note").value.trim(),
        items,
        items_total: calcItemsTotal(),
        grand_total: calcGrandTotal()
      };
    }

    function openSummary(){
      if (ORDER_CLOSED){ toast(ORDER_CLOSED_MSG); return; }
      if(state.cart.size === 0){ toast("장바구니가 비어있습니다"); return; }
      if(!minOrderOk()){
        const remain = Math.max(0, MIN_ORDER_AMOUNT - calcItemsTotal());
        toast(`최소주문금액 ${fmt(MIN_ORDER_AMOUNT)}원 ( ${fmt(remain)}원 더 담아주세요 )`);
        return;
      }

      const payload = buildPayload();

      const kv = el("summaryKV");
      kv.innerHTML = "";
      const rows = [
        ["주문번호", payload.order_id],
        ["요청일시", new Date(payload.created_at).toLocaleString("ko-KR")],
        ["주문자", `${payload.orderer.name} (${payload.orderer.dept})`],
        ["사번", payload.orderer.emp_id || "-"],
        ["주문자 연락처", payload.orderer.phone || "-"],
        ["수령자", payload.recipient.name],
        ["수령자 연락처", payload.recipient.phone],
        ["배송지", `(${payload.recipient.address.zip}) ${payload.recipient.address.addr1} ${payload.recipient.address.addr2}`],
        ["출고/배송비", `택배발송 / ${fmt(payload.shipping.fee)}원 (${payload.shipping.reason})`],
        ["비고", payload.note || "-"],
      ];
      rows.forEach(([k,v])=>{
        const kEl = document.createElement("div"); kEl.style.color="var(--muted)"; kEl.textContent = k;
        const vEl = document.createElement("div"); vEl.style.fontWeight="900"; vEl.textContent = v;
        kv.appendChild(kEl); kv.appendChild(vEl);
      });

      const body = el("summaryItems");
      body.innerHTML = "";
      payload.items.forEach(it=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.category}</td>
          <td>${it.name}</td>
          <td style="text-align:right;">${fmt(it.unit_price)}원</td>
          <td style="text-align:right;">${fmt(it.qty)}</td>
          <td style="text-align:right;">${fmt(it.line_total)}원</td>
        `;
        body.appendChild(tr);
      });

      el("summaryItemsTotal").textContent = `${fmt(payload.items_total)}원`;
      el("summaryShipFee").textContent = `${fmt(payload.shipping.fee)}원`;
      el("summaryGrandTotal").textContent = `${fmt(payload.grand_total)}원`;

      el("sendStatus").className = "status";
      el("sendStatus").textContent = "전송 대기";

      el("copyJsonBtn").onclick = async ()=>{
        try{
          await navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
          toast("JSON을 복사했습니다");
        }catch{
          toast("복사 실패: 브라우저 권한 확인");
        }
      };

      el("confirmSendBtn").disabled = false;
      el("confirmSendBtn").onclick = ()=>submit(payload);

      el("summaryBackdrop").classList.add("open");
      el("summaryBackdrop").setAttribute("aria-hidden","false");
    }

    function closeSummary(){
      el("summaryBackdrop").classList.remove("open");
      el("summaryBackdrop").setAttribute("aria-hidden","true");
    }

    async function submit(payload){
      if (ORDER_CLOSED){ toast(ORDER_CLOSED_MSG); return; }
      if(state.cart.size === 0){ toast("장바구니가 비어있습니다"); return; }
      if(calcItemsTotal() < MIN_ORDER_AMOUNT){
        const remain = Math.max(0, MIN_ORDER_AMOUNT - calcItemsTotal());
        toast(`최소주문금액 미달 (${fmt(remain)}원 더 담아주세요)`);
        return;
      }

      const st = el("sendStatus");
      const btn = el("confirmSendBtn");

      st.className="status"; st.textContent="전송 중...";
      btn.disabled = true;

      try{
        const res = await fetch(WEB_APP_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && data.ok){
          st.className="status ok"; st.textContent="제출 완료";
          toast("제출 완료");
          resetAfterSubmit();
        }else{
          st.className="status err"; st.textContent="제출 실패";
          toast("제출 실패");
          console.error("submit failed:", data);
          btn.disabled = false;
        }
      }catch(e){
        st.className="status err"; st.textContent="제출 실패";
        toast("네트워크/권한 문제");
        console.error(e);
        btn.disabled = false;
      }
    }

    function resetAfterSubmit(){
      state.cart.clear();
      renderCartForStep4();
      renderCartPreview();

      el("note").value = "";

      el("zip").value = "";
      el("addr1").value = "";
      el("addr2").value = "";
      state.shipFee = SHIPPING_BASE_FEE;
      state.shipFeeReason = "기본 무료배송";

      renderTotals();
      validateStepButtons();
      closeSummary();
      setStep(1);
    }

    function updateGateUI(){
      const status = el("gateStatus");
      const agree = el("agreeChk");
      const start = el("startBtn");

      if (ORDER_CLOSED){
        status.className = "status err";
        status.textContent = "주문 마감";
        agree.disabled = true;
        agree.checked = false;
        start.disabled = true;
        return;
      }

      if(state.policyRead){
        status.className = "status ok";
        status.textContent = "스크롤 확인 완료";
        agree.disabled = false;
      }else{
        status.className = "status err";
        status.textContent = "스크롤 확인 필요";
        agree.disabled = true;
        agree.checked = false;
      }

      start.disabled = !(state.policyRead && agree.checked);
    }

    function initGate(){
      const box = el("policyBox");
      const agree = el("agreeChk");

      state.policyRead = false;
      box.scrollTop = 0;
      agree.checked = false;

      if (ORDER_CLOSED){
        const cb = el("closedBanner");
        cb.style.display = "";
        cb.textContent = ORDER_CLOSED_MSG;
      }

      updateGateUI();

      box.addEventListener("scroll", ()=>{
        if (ORDER_CLOSED) return;
        const nearBottom = (box.scrollTop + box.clientHeight) >= (box.scrollHeight - 6);
        if(nearBottom && !state.policyRead){
          state.policyRead = true;
          toast("안내문 확인 완료");
          updateGateUI();
        }
      });

      agree.addEventListener("change", ()=>{ updateGateUI(); });

      el("startBtn").onclick = ()=>{
        if (ORDER_CLOSED){ toast(ORDER_CLOSED_MSG); return; }
        if(!(state.policyRead && agree.checked)) return;
        el("gateBackdrop").classList.remove("open");
        el("gateBackdrop").setAttribute("aria-hidden","true");
        el("app").style.display = "";
        toast("동의 확인 완료");
      };
    }

    function openImagePreview(src, title, text){
      el("imgPreviewTarget").src = src;
      el("imgPreviewTitle").textContent = title;
      el("imgPreviewText").textContent = text || "";
      el("imgPreviewText").style.display = (text && text.trim()) ? "" : "none";
      el("imgPreview").classList.add("open");
    }
    function closeImagePreview(){ el("imgPreview").classList.remove("open"); }

    function init(){
      el("maxQtyText").textContent = String(MAX_QTY_PER_ITEM);

      initGate();

      el("toStep2").onclick = ()=>setStep(2);
      el("toStep3").onclick = ()=>setStep(3);
      el("toStep4").onclick = ()=>setStep(4);
      el("backTo1").onclick = ()=>setStep(1);
      el("backTo2").onclick = ()=>setStep(2);
      el("backTo3").onclick = ()=>setStep(3);

      el("clearCartBtn").onclick = clearCart;

      [
        "ordererName","ordererEmpId","ordererPhone","ordererDept",
        "recvName","recvPhone","zip","addr1","addr2","note"
      ].forEach(id=>{
        el(id).addEventListener("input", ()=>{
          if (el("sameAsOrdererChk").checked && (id==="ordererName" || id==="ordererPhone")){
            el("recvName").value = el("ordererName").value.trim();
            el("recvPhone").value = el("ordererPhone").value.trim();
          }
          if(id==="zip") recalcShipping();
          validateStepButtons();
        });
      });

      el("addrSearchBtn").onclick = openAddressSearchEmbed;

      el("submitBtn").onclick = openSummary;
      el("closeSummaryBtn").onclick = closeSummary;
      el("summaryBackdrop").addEventListener("click", e=>{
        if(e.target===el("summaryBackdrop")) closeSummary();
      });

      renderTabs();
      renderProducts();
      renderCartForStep4();
      renderCartPreview();
      renderTotals();
      validateStepButtons();

      ["ordererPhone", "recvPhone"].forEach((id) => {
        el(id).addEventListener("input", (e) => {
          const digits = e.target.value.replace(/\D/g, "").slice(0, 11);
          if (digits.length <= 3) e.target.value = digits;
          else if (digits.length <= 7) e.target.value = digits.replace(/(\d{3})(\d+)/, "$1-$2");
          else e.target.value = digits.replace(/(\d{3})(\d{4})(\d+)/, "$1-$2-$3");
        });
      });

      el("sameAsOrdererChk").addEventListener("change", (e) => {
        const on = e.target.checked;

        if (on) {
          el("recvName").value = el("ordererName").value.trim();
          el("recvPhone").value = el("ordererPhone").value.trim();
          toast("수령자 정보에 주문자 정보를 입력했습니다");
        } else {
          el("recvName").value = "";
          el("recvPhone").value = "";
        }

        validateStepButtons();
      });
    }

    init();
  </script>

  <div class="backdrop" id="imgPreview">
    <div class="modal" style="max-width:520px;">
      <div class="modalHeader">
        <h3 id="imgPreviewTitle"></h3>
        <button class="btn" onclick="closeImagePreview()">닫기</button>
      </div>
      <div class="modalBody" style="text-align:center;">
        <img id="imgPreviewTarget" style="max-width:100%;border-radius:12px;">
        <div id="imgPreviewText" style="margin-top:10px;text-align:left;font-size:13px;line-height:1.5;color:var(--muted);white-space:pre-line;"></div>
      </div>
    </div>
  </div>
</body>
</html>
